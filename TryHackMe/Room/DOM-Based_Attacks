# DOM-Based Attacks — TryHackMe - Web Application Pentesting  
**Date:** 2025-11-06  
**Type:** TryHackMe / Classroom  
**Scope:** Lab / Authorized only

---

## 1) Context
Short summary (1–3 lines): Hands-on exploration of DOM-based vulnerabilities with emphasis on DOM-based XSS in modern SPAs (Vue). Objective: identify sources and sinks in client-side code (e.g., `location.hash`, `v-html`), craft minimal stagers to exfiltrate sensitive values (localStorage), and understand safe mitigations.

## 2) Initial hypothesis
What you expected before starting:  
Learn how DOM-based attacks work (especially DOM XSS), identify risky client-side sinks (`v-html`, `innerHTML`, jQuery `$()`), and confirm that a vulnerable SPA can be abused to exfiltrate secrets stored in the browser (e.g., `localStorage`) if a delivery channel exists.

## 3) Tools used
Short list:  
- Browser DevTools (Console, Network, Sources)  
- Minimal attacker HTTP server (to receive exfiltrated data)  
- Burp Suite (for request inspection)  
- Text editor / notes

*(No sensitive credentials or private keys included.)*

## 4) Approach (high level)
- Inspect page DOM and client JS (check included scripts such as `Bday.js`) to locate differences between components.  
- Identify sources (e.g., `location.hash`, query params, localStorage) and sinks (e.g., `v-html`, `innerHTML`, jQuery `$()`).  
- Create minimal, non-destructive stager payloads (tiny HTML snippet using `onerror`) that, when rendered by the vulnerable sink, read browser-stored secrets and send them to an attacker endpoint.  
- Use a controlled listener to capture exfiltrated values, then perform the intended test action (e.g., replace local secret and trigger UI action) in a lab environment only.  
- Document findings and propose mitigations.

## 5) Results / Evidence (sanitized)
What I observed:  
- Found a component (`person`) using `v-html` while others used safe text bindings — this is the risky sink.  
- Confirmed that injecting an HTML snippet with an `onerror` handler into the `v-html` sink caused JavaScript execution in the victim context (DOM-based XSS).  
- Used a small stager that repeatedly fetched the value of `localStorage.getItem('secret')` and sent it to my listener; the listener received the secret (proof-of-concept exfil).  
- After obtaining and replacing the secret (in the controlled lab), the intended destructive action (delete-all-users flow) could be executed and produced the expected lab output (flag link shown in console).  

Sanitized proof examples (non-sensitive):  
- “Payload rendered in `v-html` triggered fetches to attacker listener containing `secret` (received on server).”  
- “Replacing the `secret` value in localStorage and triggering the UI action resulted in the lab response that contained the flag link (lab-only proof).”

## 6) Recommended remediation
Generic technical measures:  
- **Do not use `v-html` for untrusted content.** Replace with safe text bindings or sanitized HTML.  
- **Sanitize HTML** with a well-maintained sanitizer (e.g., DOMPurify) using a strict configuration if HTML must be allowed; whitelist tags/attributes and explicitly disallow `on*` event attributes.  
- **Treat all client-sourced values as untrusted.** Validate and canonicalize URL parts (hash/query) before use.  
- **Avoid storing sensitive secrets in `localStorage`.** Use HttpOnly, Secure cookies or server-side session tokens where appropriate.  
- **Apply a strict CSP** that disallows `unsafe-inline` scripts and restricts script sources.  
- **Server-side checks for sensitive actions.** Never rely solely on client-side controls for authorization — validate requests server-side.  
- **Audit and harden SPA codepaths** for any APIs that read URL fragments, localStorage, or other client-controlled sources.

## 7) Lessons learned
- `v-html` and other HTML sinks are dangerous by design — they convert strings into DOM nodes, enabling `onerror`/`onclick` attributes to execute.  
- DOM-based XSS is real XSS: it executes in the origin and can read localStorage and tokens, then exfiltrate them.  
- Small stagers (tiny `<img onerror=...>`) are effective and reliable across frameworks and survive re-renders in SPAs.  
- In SPAs, an injected payload can persist across navigation and expand its impact; weaponisation requires a delivery channel (reflected or stored) to affect other users.  
- Practical defences combine safe templating, sanitization, secure storage, and CSP.

---

## 8) Links / Resources
- Vue security guidance: https://vuejs.org/guide/best-practices/security  
- Practical stager pattern used (educational reference): repository of lab scripts (as referenced in the lab)  
- Useful defenses: DOMPurify, CSP, OWASP XSS Prevention Cheat Sheet

---